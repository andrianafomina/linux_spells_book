# Память

Физическая и виртуальная

**Как работает виртуальная память в Linux**

Виртуальная память основана на идее отображения виртуальных адресов на физические адреса. Операционная система создает для каждого процесса собственное виртуальное адресное пространство, которое содержит:

•	**Код программы** — машинные инструкции, которые выполняет процессор.

•	**Данные программы** — глобальные переменные, статические данные и т. д.

•	**Кучу (heap)** — область памяти для динамически выделяемых данных.

•	**Стек (stack)** — используется для хранения вызовов функций и локальных переменных.

Система памяти использует **страницы** (обычно по 4 КБ), чтобы управлять блоками данных. Виртуальные страницы отображаются на физические страницы оперативной памяти, и, если свободной памяти недостаточно, операционная система выгружает неиспользуемые страницы в специальное пространство на диске (swap).

**Компоненты виртуальной памяти**

1.	**Swap-память** — выделенная область на диске, которая используется для временного хранения страниц, выгружаемых из оперативной памяти. Swap позволяет системе продолжать работать, даже если оперативной памяти недостаточно.

2.	**Страничная организация (Paging)** — позволяет разбивать память на небольшие блоки (страницы) и при необходимости переносить их между оперативной памятью и swap.

3.	**Кеширование и буферизация** — механизмы, которые позволяют быстрее работать с часто используемыми данными и файлами. Это временно сохраняет данные в оперативной памяти, повышая производительность.

| Команда | Подробности
 | Пример |
| --- | --- | --- |
| free - с ее помощью выводятся данные по использованию физической и swap-памяти. Быстрый способ проверить объем оперативной памяти. Без флажка выводит данные в байтах | free -h  (или free -human)  - вывод памяти в удобочитаемом формате

free -h -s 5 - вывод данных об используемой памяти каждые пять секунд

free -m - вывод памяти в мб |  |
| vmstat - выводятся данные о свободной памяти, памяти используемой в качестве буферов и кэша, SWAP-памяти, использовании процессора, блочных устройств и системы в целом | vmstat -w

vmstat -s - вывод статистики |  |
|  |  |  |
|  |  |  |
|  |  |  |

- Блок **procs**
    - **r** — количество процессов выполняемых в данный момент или находящихся в очереди на выполнение процессором;
    - **b** — количество процессов, ожидающих операции ввода / вывода, то есть в состоянии беспробудного сна;
    - в итоге, здесь видно что **load average** должен равняться 12 -14, и в реальности в этот момент он был 11.75. А ещё видим, что нагружен именно процессор а не ввод / вывод.
    - *Кстати, если много процессов со статусом R, а процессор не загружен, при этом load average большой, то это означает что не хватает именно ядер. У вас слишком много одновременных запросов к CPU, и он все просто не успевает обработать.*
- Блок **memory**
    - **swpd** — объем используемой виртуальной памяти;
    - **free** — объем неиспользуемой памяти (без **buff/cache**);
    - **buff** — объем памяти, используемый в качестве буфера;
    - **cache** — объем памяти, используемый в качестве дискового кэша;
    - в итоге, видно что использование памяти особо не колеблется;
- Блок **swap**
    - **si** (swap in) — блоков в секунду считываемых из swap в память;
    - **so** (swap out) — блоков в секунду перемещаемых из памяти в swap;
    - здесь видно что система не свопит, так что всё хорошо;
- Блок **io**
    - **bi** (blocks in) — блоков в секунду считанных с диска;
    - **bo** (blocks out) — блоков в секунду записанных на диск;
    - по сути, здесь видна небольшая нагрузка на диск;
- Блок **system**
    - **in** (interrupts) — количество прерываний в секунду;
    - **cs** (context switches) — количество переключений между задачами;
- Блок **cpu**
    - **us** (user time) — % времени ЦПУ, занятый на выполнение пользовательских задач;
    - **sy** (system time) — % времени ЦПУ, занятый на выполнение задач ядра;
    - **id** (idle) — % времени когда ЦПУ бездействовал;
    - **wa** — % времени ЦПУ, занятый на ожидание операций ввода / вывода;
    - **st** — сколько времени ЦПУ было украдено у виртуальной машины гипервизором (имеет смысл только при виртуализации, будет расти если виртуальной машине выделить больше ядер, чем есть физически у гипервизора).
- Блок **timestamp** — временная метка, которая была добавлена, так как я использовал опцию **t**.

Описание вывода:

- **Total memory** — количество оперативной памяти;
- **Used memory** — количество используемой памяти;
- **Active memory** — количество виртуальной памяти, которая используется процессами в данный момент;
- **Inactive memory** — количество виртуальной памяти, которая выделена, но сейчас не используется процессами;
- **Free memory** — количество свободной памяти, которую можно использовать прямо сейчас (сюда не входит буфер и дисковый кэш);
- **Buffer memory** — количество занятой памяти буфером;
- **Swap cache** — количество занятой памяти дисковым кэшем;
- **Total swap** — количество выделенной памяти на swap;
- **Used swap** — количество используемой памяти в swap;
- **Free swap** — количество свободной памяти в swap;
- **Non-nice user cpu ticks** — количество тиков процессора с повышенным приоритетом;
- **Nice user cpu ticks** — количество тиков процессора с обычным приоритетом;
- **System cpu ticks** — количество тиков процессора для процессов ядра;
- **Idle cpu ticks** — количество тиков процессора для процессов простоя;
- **IO-wait cpu ticks** — количество тиков процессора, когда он ждал систему ввода / вывода;
- **IRQ cpu ticks** — количество тиков процессора, когда он получал запросы на прерывания;
- **Softirq cpu ticks** — количество тиков процессора, когда он получал программные прерывания;
- **Stolen cpu ticks** — количество тиков процессора, когда виртуальная машина украла процессорное время;
- **Pages paged in** — количество страниц памяти, записанных в дисковый кэш;
- **Pages paged out** — количество страниц памяти, прочитанных из дискового кэша;
- **Pages swapped in** — количество страниц памяти, записанных в swap;
- **Pages swapped out** — количество страниц памяти, прочитанных из swap;
- **Interrupts** — количество прерываний с момента загрузки;
- **CPU context switches** — количество переключений контекста;
- **Boot time** — временная отметка с момента последней загрузки (количество секунд от 1 января 1970);
- **Forks** — количество forks (когда 1 процесс порождает другой процесс) с момента загрузки.

[https://habr.com/ru/companies/first/articles/647921/](https://habr.com/ru/companies/first/articles/647921/)